(function(a){a.fn.faceList=function(b,c){var d={returnID:!1,intro_text:"Enter Search Here",no_result:"No Results Found",start_value:{},limit_warning:"No More Selections Are Allowed",selectedItem:"value",selectedValues:"value",searchObj:"value",queryParam:"q",retrieveLimit:!1,extraParams:"",matchCase:!1,minChars:1,keyDelay:400,resultsHighlight:!0,neverSubmit:!1,selectionLimit:!1,start:function(){},selectionClick:function(a){},formatList:!1,retrieveComplete:function(a){return a},resultClick:function(a){},resultsComplete:function(){}},e=a.extend(d,c),f="object",g=0;if(typeof b=="string"){f="string";var h=b}else{var i=b;for(k in b)b.hasOwnProperty(k)&&g++}if(f=="object"&&g>0||f=="string")return this.each(function(b){function y(){if(lastKeyPressCode==46||lastKeyPressCode>8&&lastKeyPressCode<32)return m.hide();var b=c.val().replace(/[\\]+|[\/]+/g,"");if(b==w)return;w=b;if(b.length>=e.minChars){j.addClass("loading");if(f=="string"){var d="";e.retrieveLimit&&(d="&limit="+encodeURIComponent(e.retrieveLimit)),a.getJSON(h+"?"+e.queryParam+"="+encodeURIComponent(b)+d+e.extraParams,function(a){g=0;var c=e.retrieveComplete.call(this,a);for(k in c)c.hasOwnProperty(k)&&g++;A(c,b)})}else A(i,b)}else j.removeClass("loading"),m.hide()}function A(b,f){e.matchCase||(f=f.toLowerCase());var h=0;m.html(n.html("")).hide();for(var i=0;i<g;i++){var k=i;z++;var l=!1;if(e.searchObj=="value")var p=b[k].value;else{var p="",q=e.searchObj.split(",");for(var r=0;r<q.length;r++){var s=a.trim(q[r]);p=p+b[k][s]+" "}}p&&(e.matchCase||(p=p.toLowerCase()),p.search(f)!=-1&&o.val().search(b[k][e.selectedValues]+",")==-1&&(l=!0));if(l){var t=a('<li class="facelist-result-item" id="facelist-result-item-'+k+'"></li>').click(function(){var b=a(this).data("data"),d=b.num;if(a("#facelist-selection-"+d,j).length<=0){var f=b.attributes;c.val("").focus(),w="",o.val(o.val()+f[e.selectedValues]+","),B(f,d),e.resultClick.call(this,b),m.hide()}}).mousedown(function(){d=!1}).mouseover(function(){a("li",n).removeClass("active"),a(this).addClass("active")}).data("data",{attributes:b[k],num:z}),u=a.extend({},b[k]);if(!e.matchCase)var v=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+f+")(?![^<>]*>)(?![^&;]+;)","gi");else var v=new RegExp("(?![^&;]+;)(?!<[^<>]*)("+f+")(?![^<>]*>)(?![^&;]+;)","g");e.resultsHighlight&&(u[e.selectedItem]=u[e.selectedItem].replace(v,"<em>$1</em>")),e.formatList?t=e.formatList.call(this,u,t):t=t.html(u[e.selectedItem]),n.append(t),delete u,h++;if(e.retrieveLimit&&e.retrieveLimit==h)break}}j.removeClass("loading"),h<=0&&n.html('<li class="facelist-message">'+e.no_result+"</li>"),n.css("width",j.outerWidth()),m.show(),e.resultsComplete.call(this)}function B(b,f){var g=a('<li class="facelist-selection-item" id="facelist-selection-'+f+'"></li>').click(function(){e.selectionClick.call(this,a(this)),j.children().removeClass("selected"),a(this).addClass("selected")}).mousedown(function(){d=!1}),h=a('<a class="facelist-close">&times;</a>').click(function(){return o.val(o.val().replace(b[e.selectedValues]+",","")),g.remove(),d=!0,c.focus(),!1});l.before(g.html(b[e.selectedItem]).prepend(h))}function C(b){if(a(":visible",m).length>0){var c=a("li",m);if(b=="down")var d=c.eq(0);else var d=c.filter(":last");var e=a("li.active:first",m);e.length>0&&(b=="down"?d=e.next():d=e.prev()),c.removeClass("active"),d.addClass("active")}}e.returnID?b=e.returnID:b=b+""+Math.floor(Math.random()*100),e.start.call(this);var c=a(this);c.attr("autocomplete","off").addClass("as-input").attr("id","as-input-"+b).val(e.intro_text);var d=!1;c.wrap('<ul class="facelist-selections" id="facelist-selections-'+b+'"></ul>').wrap('<li class="facelist-original" id="facelist-original-'+b+'"></li>');var j=a("#facelist-selections-"+b),l=a("#facelist-original-"+b),m=a('<div class="facelist-results" id="facelist-results-'+b+'"></div>').hide(),n=a('<ul class="facelist-list"></ul>'),o=a('<input type="hidden" class="facelist-values" name="facelist_values_'+b+'" id="facelist-values-'+b+'" />'),p="";if(typeof e.start_value=="string"){var q=e.start_value.split(",");for(var r=0;r<q.length;r++){var s={};s[e.selectedValues]=q[r],q[r]!=""&&B(s,"000"+r)}p=e.start_value}else{p="";var t=0;for(k in e.start_value)e.start_value.hasOwnProperty(k)&&t++;if(t>0)for(var r=0;r<t;r++){var u=e.start_value[r][e.selectedValues];u==undefined&&(u=""),p=p+u+",",u!=""&&B(e.start_value[r],"000"+r)}}p!=""&&(c.val(""),o.val(p),a("li.facelist-selection-item",j).removeClass("selected")),c.after(o),j.click(function(){d=!0,c.focus()}).mousedown(function(){d=!1}).after(m);var v=null,w="",x=0;c.focus(function(){return a(this).val()==e.intro_text&&o.val()==""?a(this).val(""):d&&a(this).val()!=""&&(n.css("width",j.outerWidth()),m.show()),d=!0,!0}).blur(function(){a(this).val()==""&&o.val()==""&&p==""?a(this).val(e.intro_text):d&&(a("li.facelist-selection-item",j).removeClass("selected"),m.hide())}).keydown(function(b){lastKeyPressCode=b.keyCode,first_focus=!1;switch(b.keyCode){case 38:b.preventDefault(),C("up");break;case 40:b.preventDefault(),C("down");break;case 8:if(c.val()==""){var d=o.val().split(",");d=d[d.length-2],j.children().not(l.prev()).removeClass("selected"),l.prev().hasClass("selected")?(o.val(o.val().replace(d+",","")),l.prev().remove()):(e.selectionClick.call(this,l.prev()),l.prev().addClass("selected"))}c.val().length==1&&(m.hide(),w=""),a(":visible",m).length>0&&(v&&clearTimeout(v),v=setTimeout(function(){y()},e.keyDelay));break;case 9:case 13:var f=a("li.active:first",m);f.length>0&&(f.click(),m.hide()),(e.neverSubmit||f.length>0)&&b.preventDefault();break;default:e.selectionLimit&&a("li.facelist-selection-item",j).length>=e.selectionLimit?(n.html('<li class="facelist-message">'+e.limit_warning+"</li>"),m.show()):(v&&clearTimeout(v),v=setTimeout(function(){y()},e.keyDelay))}});var z=0})}})(jQuery)