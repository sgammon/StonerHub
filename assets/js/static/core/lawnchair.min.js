var Lawnchair=function(){if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0){var a=typeof arguments[0]=="function"?arguments[0]:arguments[1],b=typeof arguments[0]=="function"?{}:arguments[0];if(typeof a!="function")throw"No callback was provided";var c=this instanceof Lawnchair?this:new Lawnchair(b,a);c.record=b.record||"record",c.name=b.name||"records";var d;if(b.adapter)d=Lawnchair.adapters[c.indexOf(Lawnchair.adapters,b.adapter)],d=d.valid()?d:undefined;else for(var e=0,f=Lawnchair.adapters.length;e<f;e++){d=Lawnchair.adapters[e].valid()?Lawnchair.adapters[e]:undefined;if(d)break}if(!d)throw"No valid adapter.";for(var g in d)c[g]=d[g];for(var e=0,f=Lawnchair.plugins.length;e<f;e++)Lawnchair.plugins[e].call(c);return c.init(b,a),c}throw"Incorrect # of ctor args!"};Lawnchair.adapters=[],Lawnchair.adapter=function(a,b){b.adapter=a;var c="adapter valid init keys save batch get exists all remove nuke".split(" "),d=this.prototype.indexOf;for(var e in b)if(d(c,e)===-1)throw"Invalid adapter! Nonstandard method: "+e;Lawnchair.adapters.push(b)},Lawnchair.plugins=[],Lawnchair.plugin=function(a){for(var b in a)b==="init"?Lawnchair.plugins.push(a[b]):this.prototype[b]=a[b]},Lawnchair.prototype={isArray:Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},indexOf:function(a,b,c,d){if(a.indexOf)return a.indexOf(b);for(c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},lambda:function(a){return this.fn(this.record,a)},fn:function(a,b){return typeof b=="string"?new Function(a,b):b},uuid:function(){var a=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},each:function(a){var b=this.lambda(a);if(this.__results)for(var c=0,d=this.__results.length;c<d;c++)b.call(this,this.__results[c],c);else this.all(function(a){for(var c=0,d=a.length;c<d;c++)b.call(this,a[c],c)});return this}},Lawnchair.adapter("dom",function(){var a=window.localStorage,b=function(b){return{key:b+"._index_",all:function(){var b=JSON.parse(a.getItem(this.key));return b===null&&a.setItem(this.key,JSON.stringify([])),JSON.parse(a.getItem(this.key))},add:function(b){var c=this.all();c.push(b),a.setItem(this.key,JSON.stringify(c))},del:function(b){var c=this.all(),d=[];for(var e=0,f=c.length;e<f;e++)c[e]!=b&&d.push(c[e]);a.setItem(this.key,JSON.stringify(d))},find:function(a){var b=this.all();for(var c=0,d=b.length;c<d;c++)if(a===b[c])return c;return!1}}};return{valid:function(){return!!a},init:function(a,c){this.indexer=b(this.name),c&&this.fn(this.name,c).call(this,this)},save:function(b,c){var d=b.key?this.name+"."+b.key:this.name+"."+this.uuid();return this.indexer.find(d)===!1&&this.indexer.add(d),delete b.key,a.setItem(d,JSON.stringify(b)),c&&(b.key=d.replace(this.name+".",""),this.lambda(c).call(this,b)),this},batch:function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},keys:function(a){if(a){var b=this.name,c=this.indexer.all().map(function(a){return a.replace(b+".","")});this.fn("keys",a).call(this,c)}return this},get:function(b,c){if(this.isArray(b)){var d=[];for(var e=0,f=b.length;e<f;e++){var g=this.name+"."+b[e],h=JSON.parse(a.getItem(g));h&&(h.key=g,d.push(h))}c&&this.lambda(c).call(this,d)}else{var g=this.name+"."+b,h=JSON.parse(a.getItem(g));h&&(h.key=g),c&&this.lambda(c).call(this,h)}return this},all:function(b){var c=this.indexer.all(),d=[],e,f;for(var g=0,h=c.length;g<h;g++)f=c[g],e=JSON.parse(a.getItem(f)),e.key=f.replace(this.name+".",""),d.push(e);return b&&this.fn(this.name,b).call(this,d),this},remove:function(b,c){var d=this.name+"."+(typeof b=="string"?b:b.key);return this.indexer.del(d),a.removeItem(d),c&&this.lambda(c).call(this),this},nuke:function(a){return this.all(function(b){for(var c=0,d=b.length;c<d;c++)this.remove(b[c]);a&&this.lambda(a).call(this)}),this}}}()),Lawnchair.adapter("window-name",function(a,b){try{var c=window.top.name?JSON.parse(window.top.name):{}}catch(d){console.log("Suppressed Lawnchair error initializing window.name...")}return{valid:function(){return typeof window.top.name!="undefined"},init:function(d,e){c[this.name]={index:[],store:{}},a=c[this.name].index,b=c[this.name].store,this.fn(this.name,e).call(this,this)},keys:function(b){return this.fn("keys",b).call(this,a),this},save:function(d,e){var f=d.key||this.uuid();return d.key&&delete d.key,this.exists(f,function(g){g||a.push(f),b[f]=d,window.top.name=JSON.stringify(c),e&&(d.key=f,this.lambda(e).call(this,d))}),this},batch:function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},get:function(a,c){var d;if(this.isArray(a)){d=[];for(var e=0,f=a.length;e<f;e++)d.push(b[a[e]])}else d=b[a],d&&(d.key=a);return c&&this.lambda(c).call(this,d),this},exists:function(a,c){return this.lambda(c).call(this,!!b[a]),this},all:function(c){var d=[];for(var e=0,f=a.length;e<f;e++){var g=b[a[e]];g.key=a[e],d.push(g)}return this.fn(this.name,c).call(this,d),this},remove:function(d,e){var f=this.isArray(d)?d:[d];for(var g=0,h=f.length;g<h;g++)delete b[f[g]],a.splice(this.indexOf(a,f[g]),1);return window.top.name=JSON.stringify(c),e&&this.lambda(e).call(this),this},nuke:function(b){return storage={},a=[],window.top.name=JSON.stringify(c),b&&this.lambda(b).call(this),this}}}()),Lawnchair.adapter("indexed-db",function(){function a(a,b){console.log("error in indexed-db adapter!",a,b),debugger}function b(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB}return{valid:function(){return!!b()},init:function(c,d){this.idb=b(),this.waiting=[];var e=this.idb.open(this.name),f=this,g=f.fn(f.name,d),h=function(){return g.call(f,f)};e.onsuccess=function(b){f.db=e.result;if(f.db.version!="1.0"){var c=f.db.setVersion("1.0");c.onsuccess=function(a){f.store=f.db.createObjectStore("teststore",{autoIncrement:!0});for(var b=0;b<f.waiting.length;b++)f.waiting[b].call(f);f.waiting=[],h()},c.onerror=function(b){console.log("Failed to create objectstore "+b),a(b)}}else{f.store={};for(var d=0;d<f.waiting.length;d++)f.waiting[d].call(f);f.waiting=[],h()}},e.onerror=a},save:function(b,c){if(!this.store){this.waiting.push(function(){this.save(b,c)});return}var d=this,e=function(a){c&&(b.key=a.target.result,d.lambda(c).call(d,b))},f=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE,0),g=f.objectStore("teststore"),h=b.key?g.put(b,b.key):g.put(b);return h.onsuccess=e,h.onerror=a,this},batch:function(a,b){var c=[],d=!1,e=this,f=function(b){c.push(b),d=c.length===a.length},g=setInterval(function(){d&&(b&&e.lambda(b).call(e,c),clearInterval(g))},200);for(var h=0,i=a.length;h<i;h++)this.save(a[h],f);return this},get:function(b,c){if(!this.store){this.waiting.push(function(){this.get(b,c)});return}var d=this,e=function(a){c&&d.lambda(c).call(d,a.target.result)};if(!this.isArray(b)){var f=this.db.transaction("teststore").objectStore("teststore").get(b);f.onsuccess=e,f.onerror=function(c){console.log("Failed to find "+b),a(c)}}else{var g=[],h=!1,i=b,j=function(a){g.push(a),h=g.length===i.length},k=setInterval(function(){h&&(c&&d.lambda(c).call(d,g),clearInterval(k))},200);for(var l=0,m=i.length;l<m;l++)this.get(i[l],j)}return this},all:function(a){if(!this.store){this.waiting.push(function(){this.all(a)});return}var b=this.fn(this.name,a)||undefined,c=this,d=this.db.transaction("teststore").objectStore("teststore"),e=[];return d.openCursor().onsuccess=function(a){var d=a.target.result;d?(e.push(d.value),d.continue()):b&&b.call(c,e)},this},remove:function(b,c){if(!this.store){this.waiting.push(function(){this.remove(b,c)});return}typeof b=="object"&&(b=b.key);var d=this,e=function(){c&&d.lambda(c).call(d)},f=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").delete(b);return f.onsuccess=e,f.onerror=a,this},nuke:function(b){if(!this.store){this.waiting.push(function(){this.nuke(b)});return}var c=this,d=b?function(){c.lambda(b).call(c)}:function(){};try{this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").clear().onsuccess=d}catch(e){a()}return this}}}()),Lawnchair.plugin({count:function(a,b){[].slice.call(arguments).length===1&&(b=a,a="key");var c=0;this.each(function(b){b[a]&&c++}),this.fn("count",b).call(this,c)},sum:function(a,b){var c=0;this.each(function(b){b[a]&&(c+=b[a])}),this.fn("sum",b).call(this,c)},avg:function(a,b){this.sum(a,function(c){this.count(a,function(a){this.fn("avg",b).call(this,c/a)})})},min:function(a,b){this._minOrMax("min",a,b)},max:function(a,b){this._minOrMax("max",a,b)},_minOrMax:function(a,b,c){var d,e;this.all(function(c){e=c.map(function(a){return a[b]}),d=Math[a].apply(Math,e)}),this.fn(a,c).call(this,d)}}),Lawnchair.plugin(function(){var a="save batch get remove nuke".split(" "),b={before:{},after:{}};for(var c=0,d=a.length;c<d;c++)b.before[a[c]]=[],b.after[a[c]]=[];return{init:function(){for(var b=0,c=a.length;b<c;b++)this.evented(a[b])},evented:function(a){var b=this[a],c=this;this[a]=function(){var d=[].slice.call(arguments),e=d[0],f=d[d.length-1],g=!1;this.fire("before",a,e),typeof f=="function"&&(d[d.length-1]=function(b){f.call(c,b),c.fire("after",a,b)},g=!0),b.apply(c,d),g||c.fire("after",a,e)}},fire:function(a,c,d){var e=b[a][c];for(var f=0,g=e.length;f<g;f++)e[f].call(this,d)},clearBefore:function(a){b.before[a]=[]},clearAfter:function(a){b.after[a]=[]},before:function(a,c){b.before[a].push(c)},after:function(a,c){b.after[a].push(c)}}}()),Lawnchair.plugin({page:function(a,b){var c=[],d=5,e=~~a||1,f=e+1,g=e-1,h=e==1?0:g*d,i=h>=d?h+d:d;this.all(function(a){c=a});var j=Math.ceil(c.length/d),a={max:j,next:f>j?j:f,prev:g==0?1:g};return this.__results=a[this.name]=c.slice(h,i),b&&this.fn("page",b).call(this,a),this}}),Lawnchair.plugin(function(){var a=function(a,b){var c=a.split("?").filter(function(a){return a!=""}),d="";for(var e=0,f=c.length;e<f;e++)d+=c[e]+b[e];return d},b=function(a){return function(b,c){return b[a]<c[a]?-1:b[a]>c[a]?1:0}};return{where:function(){var b=[].slice.call(arguments),c=b.shift(),d=b[b.length-1],e=c.match(/\?/g),f=e&&e.length>0?a(c,b.slice(0,e.length)):c,g=new Function(this.record,"return !!("+f+")"),h=[],i;return this.all(function(a){for(var b=0,c=a.length;b<c;b++)g(a[b])&&h.push(a[b])}),this.__results=h,b.length===1&&this.fn(this.name,d).call(this,this.__results),this},asc:function(a,c){return this.fn(this.name,c).call(this,this.__results.sort(b(a))),this},desc:function(a,c){return this.fn(this.name,c).call(this,this.__results.sort(b(a)).reverse()),this}}}())